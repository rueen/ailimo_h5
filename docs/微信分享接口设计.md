# 微信分享接口设计文档

## 接口说明

为了实现微信内分享自定义卡片（标题、描述、图片），需要后端提供微信 JSSDK 配置接口。

---

## 接口地址

```
GET /api/h5/wechat-js-config
```

---

## 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| url | string | 是 | 当前页面完整 URL（包含协议、域名、路径、query、hash） |

**示例：**
```
GET /api/h5/wechat-js-config?url=https://www.ailimolab.com/#/orders/equipment/123
```

---

## 响应数据

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "appId": "wx1234567890abcdef",
    "timestamp": 1706172000,
    "nonceStr": "random_string_12345",
    "signature": "abcdef1234567890abcdef1234567890abcdef12"
  }
}
```

### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| appId | string | 微信公众号 AppID |
| timestamp | number | 时间戳（秒） |
| nonceStr | string | 随机字符串 |
| signature | string | 签名 |

---

## 后端实现要点

### 1. 获取 access_token

```
GET https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=YOUR_APPID&secret=YOUR_SECRET
```

**注意：** `access_token` 有效期 7200 秒，建议缓存，不要每次都请求。

### 2. 获取 jsapi_ticket

```
GET https://api.weixin.qq.com/cgi-bin/ticket/getjsapi_ticket?access_token=ACCESS_TOKEN
```

**注意：** `jsapi_ticket` 有效期 7200 秒，建议缓存。

### 3. 生成签名

按以下步骤生成签名：

1. 将参数按字典序排列：
```
jsapi_ticket=TICKET&noncestr=NONCESTR&timestamp=TIMESTAMP&url=URL
```

2. 对字符串做 **SHA1** 加密，得到 40 位小写字符串。

**重要：**
- `url` 必须是前端传来的**完整 URL**（包含 `#` 及 hash 路由部分）
- 不要对 `url` 做任何编码或处理，原样使用
- 参数名全小写：`jsapi_ticket`、`noncestr`、`timestamp`、`url`

### 4. 返回配置

将 `appId`、`timestamp`、`nonceStr`、`signature` 返回给前端。

---

## 配置要求

1. **JS 接口安全域名**：在微信公众平台配置 `www.ailimolab.com`
2. **HTTPS**：域名必须支持 HTTPS
3. **域名验证**：将微信提供的验证文件 `MP_verify_xxxxx.txt` 放到域名根目录

---

## 错误处理

如果生成配置失败，返回错误信息：

```json
{
  "code": 500,
  "message": "获取微信配置失败",
  "data": null
}
```

---

## 参考资料

- [微信 JSSDK 官方文档](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html)
- [微信 JS 接口签名校验工具](https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=jsapisign)
